{% extends "base.html" %}

{% block title %}
Test Generate Key API - ASAP
{% endblock %}

{% block content %}
<header class="main-header">
    <h1>ASAP</h1>
    <h2>Generate Key</h2>
    <p>Upload your images to generate a unique key!</p>
</header>

<div class="upload-container">
    <form action="/face_search/create-face-key/" method="POST" enctype="multipart/form-data" onsubmit="uploadImages(event)" class="upload-form">
        {% csrf_token %}
        <!-- ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì˜ì—­ -->
        <div class="drag-area">
            <label for="images">
                <span class="upload-icon">ğŸ“·</span>
                <p>Drag images to upload.</p>
                <p>or <span class="upload-link">upload here.</span></p>
            </label>
            <input type="file" id="images" name="images" multiple required hidden>
        </div>
        <!-- ë²„íŠ¼ -->
        <div class="button-group">
            <button type="button" class="cancel-button">Cancel</button>
            <button type="submit" class="upload-button">Generate Key</button>
        </div>
    </form>
    <!-- ë¡œë”© ë©”ì‹œì§€ -->
    <p id="loading-message" style="display: none; color: blue;">Generating key... Please wait.</p>
    <!-- ê²°ê³¼ ë©”ì‹œì§€ -->
    <div id="result-message"></div>
</div>

<script>
    function uploadImages(event) {
        event.preventDefault(); // ê¸°ë³¸ í¼ ì œì¶œ ë™ì‘ ë°©ì§€

        const form = event.target;
        const formData = new FormData(form);
        const message = document.getElementById("loading-message");
        const result = document.getElementById("result-message");
        const startTime = Date.now(); // ì²˜ë¦¬ ì‹œì‘ ì‹œê°„ ê¸°ë¡

        // ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ
        message.style.display = "block";
        result.innerHTML = ""; // ê²°ê³¼ ì´ˆê¸°í™”

        fetch(form.action, {
            method: "POST",
            body: formData,
            headers: {
                "X-CSRFToken": form.querySelector('[name="csrfmiddlewaretoken"]').value
            }
        })
            .then(response => response.json())
            .then(data => {
                const endTime = Date.now(); // ì²˜ë¦¬ ì¢…ë£Œ ì‹œê°„ ê¸°ë¡
                const duration = ((endTime - startTime) / 1000).toFixed(2); // ì†Œìš” ì‹œê°„ ê³„ì‚°

                if (data.key) {
                    const fileNameWithoutExtension = data.key.split("\\").pop().replace(/\.pkl$/, "");

                    result.innerHTML = `
                        <p style="color: green;">Key generation successful!</p>
                        <p>Generated Key: <strong>${fileNameWithoutExtension}</strong></p>
                        <p>Processing time: <strong>${duration} seconds</strong></p>
                    `;
                } else {
                    result.innerHTML = `<p style="color: red;">Error: ${data.error}</p>`;
                }
            })
            .catch(error => {
                result.innerHTML = `<p style="color: red;">An unexpected error occurred: ${error}</p>`;
            })
            .finally(() => {
                message.style.display = "none"; // ë¡œë”© ë©”ì‹œì§€ ìˆ¨ê¹€
            });
    }
</script>
{% endblock %}
